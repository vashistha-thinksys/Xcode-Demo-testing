default_platform(:ios)

platform :ios do
  lane :setup_and_release do
    # 1. Use App Store Connect API key to avoid 2FA
    app_store_connect_api_key(
      key_id: "5LWS2HQH72",
      issuer_id: "69a6de7a-9e78-47e3-e053-5b8c7c11a4d1",
      key_filepath: "./AuthKey_5LWS2HQH72.p8",
      duration: 1200, # Optional: max 1200
      in_house: false # Optional: set to true if using enterprise account
    )

    # 2. Create the app identifier if it doesn't exist yet
    produce(
      app_identifier: "com.example.myapp", # Your app's bundle ID
      app_name: "My App",                  # Your app's name
      sku: "myapp123",                     # A unique SKU for your app
      language: "English",                 # Primary language for the app
      skip_itc: false                      # Create app in App Store Connect
    )

    # 3. Create and manage provisioning profiles using Match
    match(
      type: "development",                   # Use 'development', 'adhoc', or 'enterprise' if needed
      app_identifier: "com.example.myapp", # Your app's bundle ID
      readonly: false                     # Allow creation of new certificates
    )

    # 4. Build the app
    gym(
      scheme: "MyAppScheme",               # Replace with your app's scheme
      export_method: "app-store",          # Use 'ad-hoc' for adhoc distribution
      output_name: "MyApp.ipa"             # The output .ipa file name
    )

    # 5. Upload the build to TestFlight
    pilot(
      ipa: "MyApp.ipa",                    # The path to the .ipa file
      skip_waiting_for_build_processing: true # Optional: skip waiting for processing
    )
  end
end
